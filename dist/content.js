(()=>{var T={PROJECTS:"gcm_projects",CHAT_MAPPINGS:"gcm_chat_mappings"},U=()=>{try{return chrome.runtime?.id!==void 0}catch{return!1}},tt=()=>new Promise(t=>{if(!U()){t({projects:[],chatMappings:{}});return}try{chrome.storage.sync.get([T.PROJECTS,T.CHAT_MAPPINGS],e=>{if(chrome.runtime.lastError){console.warn("[GCM] Storage read error:",chrome.runtime.lastError),t({projects:[],chatMappings:{}});return}t({projects:e[T.PROJECTS]||[],chatMappings:e[T.CHAT_MAPPINGS]||{}})})}catch{console.warn("[GCM] Extension context invalidated"),t({projects:[],chatMappings:{}})}}),A=t=>{if(!U())return Promise.resolve();try{return chrome.storage.sync.set({[T.PROJECTS]:t})}catch{return console.warn("[GCM] Extension context invalidated"),Promise.resolve()}},M=t=>{if(!U())return Promise.resolve();try{return chrome.storage.sync.set({[T.CHAT_MAPPINGS]:t})}catch{return console.warn("[GCM] Extension context invalidated"),Promise.resolve()}};var q={projects:[],chatMappings:{},lastClickedChatInfo:null,containerInjected:!1},C=()=>q.projects,y=()=>q.chatMappings,D=()=>q.lastClickedChatInfo;var I=t=>{q.projects=t},P=t=>{q.chatMappings=t},et=t=>{q.lastClickedChatInfo=t};var nt=()=>`p_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;var w=t=>{if(!t||typeof t!="string")return null;let e=t.trim();return e?e.startsWith("c_")?e:`c_${e}`:null},ct=(t={})=>{let e={};return Object.entries(t).forEach(([o,n])=>{let s=w(o);if(s){if(e[s]){e[s]={...e[s],...n};return}e[s]=n}}),e},it=t=>{if(!t||typeof t!="string")return"";let e=t.replace(/\s+/g," ").trim();if(!e)return"";let o=e.toLowerCase();return o==="gemini"||o==="chats"?"":e},qt=()=>{let t=document.title||"";if(!t)return"";let e=t.replace(/\s*[-|]\s*gemini.*$/i,"").trim();return it(e)},Gt=()=>{let t=['main [data-test-id="conversation-title"]','main [data-test-id="conversation-title-text"]','main [data-test-id="chat-title"]',"main h1","main h2",'[data-test-id="conversation-title"]','[data-test-id="conversation-title-text"]','[data-test-id="chat-title"]'];for(let e of t){let o=document.querySelector(e),n=it(o?.textContent);if(n)return n}return qt()},ot=t=>{if(!t)return null;let e=t.match(/c_[a-zA-Z0-9_-]{8,}/);return e?w(e[0]):null},st=t=>{if(!t||typeof t!="string")return null;let e=t.split(/[?#]/)[0],o=e.match(/\/app\/([a-zA-Z0-9_-]+)/);return o||(o=e.match(/\/gem\/[^/]+\/([a-zA-Z0-9_-]+)/)),o||(o=e.match(/\/c\/([a-zA-Z0-9_-]+)/)),o?w(o[1]):null},rt=t=>{if(!t||typeof t!="string")return null;try{let e=new URL(t,window.location.origin);return st(e.pathname)}catch{return st(t)}},Bt=t=>!t||typeof t!="string"?!1:t.includes("c_")?/c_[a-zA-Z0-9_-]{8,}/.test(t):/^[a-f0-9]{10,}$/i.test(t),Ht=t=>{if(!t)return null;let e=t.getAttribute("data-conversation-id")||t.getAttribute("data-chat-id")||t.dataset?.conversationId||t.dataset?.chatId;return Bt(e)?w(e):null},x=t=>{if(!t)return null;let e=t.querySelector('[data-test-id="conversation"]'),o=[e,t];for(let m of o){let a=m?.getAttribute?.("jslog"),g=ot(a);if(g)return g;let b=Ht(m);if(b)return b}let n=t.querySelector("[jslog]"),s=ot(n?.getAttribute("jslog"));if(s)return s;let r=(e?.getAttribute?.("href")?e:e?.querySelector?.("a[href]")||t.querySelector("a[href]"))?.getAttribute?.("href"),i=rt(r);if(i)return i;let d=e?.getAttribute?.("data-href")||t.getAttribute?.("data-href");return rt(d)},V=t=>{let e=w(t);if(!e)return null;let o=document.querySelectorAll(".conversation-items-container");for(let n of o){let s=x(n);if(s&&s===e)return n}return null},R=(t,e,o,n)=>{let s=y(),c=w(t);if(!c)return;c!==t&&delete s[t];let r=s[c];s[c]={projectId:o,title:e,addedAt:r?.addedAt||Date.now()},P(s),M(s),zt(c),n&&n()},H=(t,e)=>{let o=y(),n=w(t);n&&delete o[n],t&&t!==n&&delete o[t],P(o),M(o),Nt(n||t),e&&e()},zt=t=>{let e=w(t);if(!e)return;document.querySelectorAll(".conversation-items-container").forEach(n=>{let s=x(n);s&&s===e&&(n.style.display="none",n.dataset.gcmHidden="true")})},Nt=t=>{let e=w(t);if(!e)return;document.querySelectorAll(".conversation-items-container").forEach(n=>{let s=x(n);s&&s===e&&(n.style.display="",delete n.dataset.gcmHidden)})},Z=()=>{let t=y(),e=new Set(Object.keys(t).map(n=>w(n)).filter(Boolean));document.querySelectorAll(".conversation-items-container").forEach(n=>{let s=x(n);s&&e.has(s)?(n.style.display!=="none"&&(n.style.display="none"),n.dataset.gcmHidden="true"):n.dataset.gcmHidden==="true"&&(n.style.display="",delete n.dataset.gcmHidden)})},at=()=>{let t=y(),e=new Set(Object.keys(t).map(n=>w(n)).filter(Boolean));document.querySelectorAll(".conversation-items-container").forEach(n=>{let s=x(n);s&&!e.has(s)&&n.style.display==="none"&&(n.style.display="",delete n.dataset.gcmHidden)})},dt=()=>!1,J=()=>{let t=window.location.pathname.match(/\/app\/([a-zA-Z0-9_-]+)/);return t||(t=window.location.pathname.match(/\/gem\/[^/]+\/([a-zA-Z0-9_-]+)/)),t||(t=window.location.pathname.match(/\/c\/([a-zA-Z0-9_-]+)/)),t?t[1]:null},lt=()=>{let t=["projects","chats","gemini","recent","starred","untitled","untitled chat"],e=J(),o=w(e);if(!o)return!1;let n=Gt();if(!n)return!1;if(t.includes(n.toLowerCase()))return console.log("[GCM DEBUG] Rejecting invalid title sync:",n),!1;let s=y(),c=s[o];return c&&c.title!==n?(s[o]={...c,title:n},P(s),M(s),!0):!1},mt=t=>`/app/${t.startsWith("c_")?t.substring(2):t}`;var G=null,W=()=>{G&&(G.remove(),G=null)},K=(t,e,o)=>{W();let n=document.createElement("div");n.classList.add("gcm-context-menu"),n.style.left=`${t}px`,n.style.top=`${e}px`,o.forEach(c=>{let r=document.createElement("button");r.classList.add("gcm-context-item"),c.danger&&r.classList.add("danger"),r.textContent=c.label,r.addEventListener("click",()=>{W(),c.action()}),n.appendChild(r)}),document.body.appendChild(n),G=n;let s=n.getBoundingClientRect();s.right>window.innerWidth&&(n.style.left=`${window.innerWidth-s.width-8}px`),s.bottom>window.innerHeight&&(n.style.top=`${window.innerHeight-s.height-8}px`)},ut=()=>{document.addEventListener("click",t=>{G&&!G.contains(t.target)&&W()})};var pt=(t,e)=>{let o=C(),n={id:nt(),name:t,order:o.length,createdAt:Date.now()};o.push(n),I(o),A(o),e&&e()},ht=(t,e,o)=>{let n=C(),s=n.find(c=>c.id===t);s&&(s.name=e,I(n),A(n)),o&&o()},gt=(t,e)=>{let o=C(),n=y();o=o.filter(s=>s.id!==t),Object.keys(n).forEach(s=>{n[s]?.projectId===t&&delete n[s]}),I(o),P(n),A(o),M(n),e&&e()},ft=(t,e,o,n)=>{let s=C(),c=s.find(r=>r.id===t);c&&(c.gemId=e,c.gemName=o,I(s),A(s)),n&&n()},$=(t,e,o)=>{let n=C(),s=n.find(c=>c.id===t);s&&(s.isExpanded=e,I(n),A(n)),o&&o()},vt=(t,e)=>{let o=C(),n=o.find(s=>s.id===t);n&&(delete n.gemId,delete n.gemName,I(o),A(o)),e&&e()},Ct=t=>{let e=y(),o=[];Object.entries(e).forEach(([r,i])=>{i.projectId===t&&o.push({id:r,title:i.title,addedAt:i.addedAt||0})});let n=new Map,s=[];document.querySelectorAll(".conversation-items-container").forEach(r=>{let i=x(r),d=r.querySelector(".conversation-title");if(i){let m=d?.textContent?.trim()||"Untitled";n.set(i,m),s.push(i)}});let c=o.map(r=>{let i=n.get(r.id);return{...r,title:i||r.title,isLoaded:n.has(r.id)}});return c.sort((r,i)=>{if(r.isLoaded&&i.isLoaded){let a=s.indexOf(r.id),g=s.indexOf(i.id);return a-g}if(r.isLoaded&&!i.isLoaded)return-1;if(!r.isLoaded&&i.isLoaded)return 1;let d=r.addedAt||0;return(i.addedAt||0)-d}),c};var Y=(t,e,o,n="")=>{let s=document.createElement("div");s.classList.add("gcm-modal-overlay");let c=document.createElement("div");c.classList.add("gcm-modal"),c.innerHTML=`
    <h3 class="gcm-modal-title">${t}</h3>
    <input type="text" class="gcm-modal-input" placeholder="${e}" value="${n}">
    <div class="gcm-modal-actions">
      <button class="gcm-modal-btn cancel">Cancel</button>
      <button class="gcm-modal-btn primary">Confirm</button>
    </div>
  `,s.appendChild(c),document.body.appendChild(s);let r=c.querySelector(".gcm-modal-input"),i=c.querySelector(".cancel"),d=c.querySelector(".primary");r.focus(),r.select();let m=()=>s.remove();i.addEventListener("click",m),s.addEventListener("click",a=>{a.target===s&&m()}),d.addEventListener("click",()=>{let a=r.value.trim();a&&(o(a),m())}),r.addEventListener("keydown",a=>{if(a.key==="Enter"){let g=r.value.trim();g&&(o(g),m())}else a.key==="Escape"&&m()})};var _t=()=>{let t=[],e=new Set;return document.querySelectorAll("bot-list-item").forEach(o=>{let s=o.querySelector(".bot-name")?.textContent?.trim(),r=o.querySelector(".bot-item")?.getAttribute("jslog");if(r&&s){let i=r.match(/"([a-f0-9]{10,14})"/);i&&!e.has(i[1])&&(e.add(i[1]),t.push({id:i[1],name:s}))}}),t},Rt=t=>{let e=document.createElement("div");e.classList.add("gcm-modal-overlay");let o=_t(),n="";o.length===0?n='<div class="gcm-empty">No Gems found. Make sure your Gems are visible in the sidebar.</div>':n=o.map(c=>`<div class="gcm-gem-item" data-gem-id="${c.id}" data-gem-name="${c.name}">${c.name}</div>`).join(""),e.innerHTML=`
    <div class="gcm-modal">
      <h3 class="gcm-modal-title">Select Gem</h3>
      <div class="gcm-gem-list">${n}</div>
      <div class="gcm-modal-actions">
        <button class="gcm-modal-btn cancel">Cancel</button>
      </div>
    </div>
  `,document.body.appendChild(e),e.querySelector(".cancel").addEventListener("click",()=>e.remove()),e.querySelectorAll(".gcm-gem-item").forEach(c=>{c.addEventListener("click",()=>{let r=c.dataset.gemId,i=c.dataset.gemName;t(r,i),e.remove()})}),e.addEventListener("click",c=>{c.target===e&&e.remove()})},$t=()=>{let t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.setAttribute("viewBox","0 0 24 24"),t.classList.add("gcm-project-icon"),t.innerHTML='<path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>',t},Ot=()=>{let t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.setAttribute("viewBox","0 0 24 24"),t.setAttribute("width","20"),t.setAttribute("height","20"),t.style.fill="currentColor",t.innerHTML='<path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>',t},Ft=()=>document.querySelector('conversations-list[data-test-id="all-conversations"]'),Ut=t=>{let e=mt(t);!e||window.location.pathname===e||(window.history.pushState({},"",e),window.dispatchEvent(new PopStateEvent("popstate")))},xt=!1,bt=()=>xt,yt=!1,Dt=()=>{if(yt)return;let t=document.querySelector(".gcm-project-header"),e=document.querySelector(".gcm-chat"),o=t?.getBoundingClientRect().height??null,n=e?.getBoundingClientRect().height??null;console.log("[GCM] Rendered row heights",{project:o,chat:n}),yt=!0},f=()=>{let t=Ft();if(!t)return;let e=document.getElementById("gcm-container");e||(e=document.createElement("div"),e.id="gcm-container",e.classList.add("gcm-container"),t.insertBefore(e,t.firstChild),xt=!0);let o=C(),n=J();e.innerHTML=`
    <div class="gcm-header">
      <h2 class="gcm-title">Projects</h2>
      <button class="gcm-add-btn" id="gcm-add-project">+ Add</button>
    </div>
    <ul class="gcm-projects" id="gcm-projects-list"></ul>
  `;let s=e.querySelector("#gcm-projects-list");e.querySelector("#gcm-add-project").addEventListener("click",()=>{Y("Create Project","Project name",r=>{pt(r,f)})}),o.length===0?s.innerHTML='<li class="gcm-empty">No projects yet. Click "+ Add" to create one.</li>':o.forEach(r=>{let i=Ct(r.id),d=document.createElement("li");d.classList.add("gcm-project"),d.dataset.projectId=r.id,r.isExpanded&&d.classList.add("expanded");let m=document.createElement("div");m.classList.add("gcm-project-header"),m.appendChild($t());let a=document.createElement("button");a.classList.add("gcm-expand-btn"),a.innerHTML=`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>`,a.addEventListener("click",h=>{h.stopPropagation(),d.classList.toggle("expanded"),$(r.id,d.classList.contains("expanded"))}),m.appendChild(a);let g=document.createElement("span");g.classList.add("gcm-project-name"),g.textContent=r.name,m.appendChild(g);let b=document.createElement("span");b.classList.add("gcm-project-count"),b.textContent=i.length,m.appendChild(b);let v=document.createElement("button");v.classList.add("gcm-project-menu-btn"),v.appendChild(Ot()),v.addEventListener("click",h=>{h.stopPropagation();let u=[{label:r.gemId?"Change Gem":"Set Gem",action:()=>{Rt((l,E)=>{ft(r.id,l,E,f)})}}];r.gemId&&u.push({label:"Clear Gem",action:()=>vt(r.id,f)}),u.push({label:"Rename",action:()=>Y("Rename Project","New name",l=>{ht(r.id,l,f)},r.name)},{label:"Delete",danger:!0,action:()=>{confirm(`Delete "${r.name}"? Chats will not be deleted.`)&&gt(r.id,f)}}),K(h.clientX,h.clientY,u)}),m.appendChild(v),m.addEventListener("click",()=>{if(r.gemId){let h=!1;document.querySelectorAll("bot-list-item .bot-item").forEach(u=>{let l=u.getAttribute("jslog");if(l&&l.includes(r.gemId)){let E=u.querySelector("button.bot-new-conversation-button");E&&(E.click(),h=!0)}}),h||(d.classList.toggle("expanded"),$(r.id,d.classList.contains("expanded")))}else d.classList.toggle("expanded"),$(r.id,d.classList.contains("expanded"))}),d.appendChild(m);let p=document.createElement("ul");if(p.classList.add("gcm-chats"),i.length===0){let h=document.createElement("li");h.classList.add("gcm-empty"),h.textContent="No chats in this project",p.appendChild(h)}else i.forEach(h=>{let u=document.createElement("li");u.classList.add("gcm-chat"),n&&(h.id===n||h.id===`c_${n}`||h.id.substring(2)===n)&&u.classList.add("active");let E=document.createElement("span");E.classList.add("gcm-chat-title"),E.textContent=h.title,u.appendChild(E);let S=document.createElement("button");S.classList.add("gcm-chat-menu-btn"),S.innerHTML=`<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>`,S.addEventListener("click",L=>{L.stopPropagation();let j=O=>{let B=V(h.id),X=B?.querySelector(".conversation-actions-menu-button");if(X&&B){let F=[document.querySelector('[data-test-id="overflow-container"]'),document.querySelector(".overflow-container"),document.querySelector("infinite-scroller")].filter(Boolean),Q=F.map(_=>_.scrollTop),N=document.createElement("style");return N.id="gcm-hide-native-menu",N.textContent=`
                                    .cdk-overlay-container { opacity: 0 !important; pointer-events: none !important; }
                                    .conversation-items-container[data-gcm-hidden="true"] { 
                                        visibility: visible !important;
                                        opacity: 0 !important; 
                                        pointer-events: auto !important;
                                        position: fixed !important;
                                        top: -9999px !important;
                                        left: -9999px !important;
                                        width: 1px !important;
                                        height: 1px !important;
                                        clip: rect(0, 0, 0, 0) !important;
                                        overflow: hidden !important;
                                    }
                                `,document.head.appendChild(N),X.click(),F.forEach((_,k)=>{_.scrollTop=Q[k]}),setTimeout(()=>{document.querySelectorAll('.mat-mdc-menu-panel [role="menuitem"]').forEach(k=>{k.textContent?.trim().toLowerCase().includes(O.toLowerCase())&&(N.remove(),k.click())}),document.getElementById("gcm-hide-native-menu")&&document.getElementById("gcm-hide-native-menu").remove(),F.forEach((k,Tt)=>{k.scrollTop=Q[Tt]})},100),!0}return!1};K(L.clientX,L.clientY,[{label:"Share conversation",action:()=>j("share")},{label:"Pin",action:()=>j("pin")},{label:"Rename",action:()=>j("rename")},{label:"Remove from Project",danger:!0,action:()=>H(h.id,f)},{label:"Delete",danger:!0,action:()=>{j("delete")||H(h.id,f)}}])}),u.appendChild(S),u.addEventListener("click",L=>{if(L.target.closest(".gcm-chat-menu-btn"))return;let j=V(h.id),B=j?.querySelector('[data-test-id="conversation"]')||j?.querySelector('[role="button"]')||j;B?(j&&(j.style.display=""),B.click(),setTimeout(()=>{j&&(j.style.display="none")},100)):Ut(h.id)}),p.appendChild(u)});d.appendChild(p),s.appendChild(d)}),requestAnimationFrame(Dt)};var Et="gcm-move-to-project-item",Vt=t=>{if(t.querySelector(`#${Et}`))return;let e=C(),o=D(),n=y();if(!o)return;let s=t.querySelectorAll('[role="menuitem"], .mat-mdc-menu-item, button.mdc-list-item');if(s.length===0)return;let c=Array.from(s).map(v=>v.textContent?.toLowerCase()||"").join(" ");if(!(c.includes("delete")||c.includes("share")||c.includes("pin")||c.includes("rename")))return;let d=!!n[o.id]?.projectId,m=s[s.length-1],a=document.createElement("button");a.id=Et,a.setAttribute("role","menuitem"),a.className="mat-mdc-menu-item mat-mdc-focus-indicator mdc-list-item gcm-move-item",a.style.cssText=`
    position: relative;
    padding: 0 16px;
    height: 48px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: ${d?"#f28b82":"#e3e3e3"};
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    font-family: inherit;
  `;let g=document.createElementNS("http://www.w3.org/2000/svg","svg");g.setAttribute("viewBox","0 0 24 24"),g.setAttribute("width","20"),g.setAttribute("height","20"),g.style.fill=d?"#f28b82":"#e3e3e3",g.innerHTML='<path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>';let b=document.createElement("span");if(b.textContent=d?"Remove from Project":"Move to Project",b.style.flex="1",a.appendChild(g),a.appendChild(b),d)a.addEventListener("click",v=>{v.stopPropagation(),H(o.id,f),document.body.click()}),a.addEventListener("mouseenter",()=>{a.style.background="rgba(255, 255, 255, 0.08)"}),a.addEventListener("mouseleave",()=>{a.style.background=""});else{let v=document.createElement("span");v.textContent="\u203A",v.style.cssText="font-size: 16px; color: #9aa0a6;",a.appendChild(v);let p=document.createElement("div");if(p.classList.add("gcm-native-submenu"),p.style.cssText=`
      position: fixed;
      background: #202124;
      border-radius: 4px;
      padding: 0;
      min-width: 160px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 8px 3px rgba(0,0,0,0.15);
      display: none;
      z-index: 10002;
      font-family: "Google Sans", Roboto, sans-serif;
      overflow: hidden;
    `,e.length===0){let u=document.createElement("div");u.style.cssText="padding: 12px 16px; color: #9aa0a6; font-size: 14px;",u.textContent="No projects yet",p.appendChild(u)}else e.forEach(u=>{let l=document.createElement("div");l.style.cssText=`
          padding: 12px 16px;
          cursor: pointer;
          font-size: 14px;
          color: #e8eaed;
          font-family: "Google Sans", Roboto, sans-serif;
          transition: background 0.1s;
        `,l.textContent=u.name,l.addEventListener("mouseenter",()=>{l.style.background="rgba(255, 255, 255, 0.1)"}),l.addEventListener("mouseleave",()=>{l.style.background=""}),l.addEventListener("click",E=>{if(E.stopPropagation(),o){R(o.id,o.title,u.id,f),p.remove(),document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",keyCode:27,bubbles:!0}));let S=document.querySelector(".cdk-overlay-backdrop");S&&S.click(),document.querySelectorAll(".mat-mdc-menu-panel").forEach(L=>{L.remove()}),document.querySelectorAll(".cdk-overlay-pane").forEach(L=>{L.querySelector(".mat-mdc-menu-panel")&&L.remove()})}}),p.appendChild(l)});document.body.appendChild(p),a.addEventListener("mouseenter",()=>{a.style.background="rgba(255, 255, 255, 0.08)";let u=a.getBoundingClientRect();p.style.left=`${u.right}px`,p.style.top=`${u.top}px`,p.style.display="block";let l=p.getBoundingClientRect();l.right>window.innerWidth&&(p.style.left=`${u.left-l.width}px`),l.bottom>window.innerHeight&&(p.style.top=`${window.innerHeight-l.height-8}px`)}),a.addEventListener("mouseleave",u=>{let l=u.relatedTarget;p.contains(l)||(a.style.background="",p.style.display="none")}),p.addEventListener("mouseleave",()=>{a.style.background="",p.style.display="none"});let h=()=>{document.body.contains(t)||(p.remove(),document.removeEventListener("click",h))};setTimeout(()=>document.addEventListener("click",h),100)}m&&m.parentElement&&m.parentElement.insertBefore(a,m)},jt=()=>{let t=["projects","chats","gemini","recent","starred","untitled"];document.addEventListener("click",e=>{let o=e.target.closest(".conversation-actions-menu-button")||e.target.closest('[data-test-id="actions-menu-button"]')||e.target.closest('button[aria-haspopup="menu"]');if(o){let n=o.closest(".conversation-items-container");if(console.log("[GCM DEBUG] Menu button clicked, conversationContainer:",n),n){let s=n.querySelector(".conversation-title"),c=s?.textContent?.trim()||"Untitled Chat",r=x(n);console.log("[GCM DEBUG] Extracted chat info:",{chatId:r,title:c,titleEl:s});let i=c&&!t.includes(c.toLowerCase());r&&i?et({id:r,title:c}):console.log("[GCM DEBUG] Invalid chat info, not setting lastClickedChat:",{chatId:r,title:c,isValidTitle:i})}}},!0)},wt=()=>{new MutationObserver(e=>{for(let o of e)for(let n of o.addedNodes){if(n.nodeType!==Node.ELEMENT_NODE)continue;let c=n.classList?.contains("cdk-overlay-pane")?n.querySelector(".mat-mdc-menu-panel"):null,r=n.classList?.contains("mat-mdc-menu-panel"),i=c||(r?n:null);i&&D()&&setTimeout(()=>Vt(i),50)}}).observe(document.body,{childList:!0,subtree:!0})};var z=new Set,Lt=!1,Pt=null,St=()=>{let t=window.location.pathname.match(/\/gem\/([^/?]+)/);return t?t[1]:null},At=t=>C().find(o=>o.gemId===t),It=t=>t.querySelector(".conversation-title")?.textContent?.trim()||"Untitled Chat",Zt=()=>{Lt||(document.querySelectorAll(".conversation-items-container").forEach(t=>{let e=x(t);e&&z.add(e)}),Lt=!0)},Mt=t=>{let e=x(t);if(!e)return;if(y()[e]){z.add(e);return}if(z.has(e))return;z.add(e);let n=St();if(!n)return;let s=At(n);if(!s)return;let c=It(t);console.log(`[GCM] Auto-assigning chat "${c}" to project "${s.name}"`),setTimeout(()=>{let r=x(t)||e,i=It(t)||c;R(r,i,s.id,Pt),z.add(r)},150)},kt=t=>{Pt=t,setTimeout(Zt,1e3),new MutationObserver(o=>{let n=St();!n||!At(n)||o.forEach(c=>{c.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(r.classList?.contains("conversation-items-container")&&Mt(r),r.querySelectorAll?.(".conversation-items-container").forEach(i=>{Mt(i)}))})})}).observe(document.body,{childList:!0,subtree:!0})};var Jt="1.1.8";console.log(`[GCM] Gemini Chat Manager v${Jt} loaded`);var Wt=()=>document.querySelector('conversations-list[data-test-id="all-conversations"]'),Kt=async()=>{let t=["projects","chats","gemini","recent","starred","untitled","untitled chat"],e=await tt();console.log("[GCM DEBUG] Loaded data from storage:",JSON.stringify(e)),I(e.projects);let o=ct(e.chatMappings),n=new Set(e.projects.map(i=>i.id)),s={};Object.entries(o).forEach(([i,d])=>{let m=d?.projectId&&n.has(d.projectId),a=d?.title&&!t.includes(d.title.toLowerCase());m&&a?s[i]=d:console.log("[GCM] Removing invalid chat mapping:",{chatId:i,chatData:d,hasValidProject:m,hasValidTitle:a})}),P(s),M(s),ut(),jt(),wt();let c=0,r=setInterval(()=>{c++;let i=Wt();if((i||c>60)&&(clearInterval(r),i)){f();let d=null,m=(l,E)=>()=>{d&&clearTimeout(d),d=setTimeout(l,E)},a=!1,g=()=>{let l=document.getElementById("gcm-container");return l?l.matches(":hover"):!1},b=()=>{if(g()){if(a)return;a=!0;let l=()=>{if(!g()){a=!1,f();return}setTimeout(l,150)};setTimeout(l,150);return}a=!1,f()},v=m(()=>{Z()},300),p=m(()=>{b()},200);new MutationObserver(()=>{(!bt()||!document.getElementById("gcm-container"))&&p(),v()}).observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{Z(),at()},500),kt(p),setInterval(()=>{dt()&&p()},1e4);let u=window.location.href;setInterval(()=>{window.location.href!==u&&(u=window.location.href,f())},200),setInterval(()=>{if(lt()){p();return}p()},3e3)}},200)};Kt();})();
